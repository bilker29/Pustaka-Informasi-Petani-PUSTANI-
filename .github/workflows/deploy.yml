name: CI/CD Pipeline Level 3

on:
  push:
    branches:
      - main
      - dev  # <--- TAMBAHKAN TRIGGER DEV

jobs:
  # ... (Job build-test dan build-docker TETAP SAMA seperti sebelumnya) ...
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      # ... (sisa step testing sama) ...

  build-docker:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      # ... (proses build image sama) ...
      # Pastikan image tag tetap 'latest' atau bisa gunakan SHA agar unik

  deploy:
    needs: build-docker
    runs-on: ubuntu-latest
    steps:
      - name: Set Environment Variables
        run: |
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
            echo "DEPLOY_ENV=prod" >> $GITHUB_ENV
            echo "APP_PORT=80" >> $GITHUB_ENV
            echo "APP_NAME=pustani-prod" >> $GITHUB_ENV
            echo "DEPLOY_PATH=/var/www/pustani-prod" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=dev" >> $GITHUB_ENV
            echo "APP_PORT=8080" >> $GITHUB_ENV
            echo "APP_NAME=pustani-dev" >> $GITHUB_ENV
            echo "DEPLOY_PATH=/var/www/pustani-dev" >> $GITHUB_ENV
          fi

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: APP_PORT,APP_NAME,DEPLOY_PATH,DEPLOY_ENV
          script: |
            # 1. Buat folder jika belum ada
            mkdir -p $DEPLOY_PATH
            
            # 2. Masuk ke folder
            cd $DEPLOY_PATH
            
            # 3. Clone/Pull update terbaru
            # (Trik: Kita clone repo sekali, lalu pull)
            if [ ! -d ".git" ]; then
              git clone https://github.com/bilker29/Pustaka-Informasi-Petani-PUSTANI-.git .
            fi
            
            # Reset dan checkout branch yang sesuai
            git fetch --all
            if [ "$DEPLOY_ENV" == "prod" ]; then
              git checkout main
            else
              git checkout dev
            fi
            git pull origin $DEPLOY_ENV
            
            # 4. Export Variabel untuk Docker Compose
            export APP_NAME=$APP_NAME
            export HOST_PORT=$APP_PORT
            export APP_ENV=$DEPLOY_ENV
            
            # 5. Jalankan Docker Compose
            # Gunakan -p (project name) agar container Dev dan Prod terpisah
            docker-compose -p $APP_NAME pull
            docker-compose -p $APP_NAME up -d --remove-orphans