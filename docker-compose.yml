version: '3.8'

services:
  pustani-app:
    build: ./Tubes
    # Gunakan variabel agar nama container dinamis (misal: pustani-app-prod / pustani-app-dev)
    container_name: ${APP_NAME}-app 
    restart: always
    environment:
      - APP_ENV=${APP_ENV} # PROD atau DEV
      - DB_HOST=${APP_NAME}-db
      - DB_USER=docker_user
      - DB_PASSWORD=docker_pass
      - DB_NAME=pustani_db
    networks:
      - pustani-net

  pustani-info:
    build: ./info-service
    container_name: ${APP_NAME}-info
    restart: always
    networks:
      - pustani-net

  pustani-db:
    image: mariadb:10.6
    container_name: ${APP_NAME}-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: pustani_db
      MYSQL_USER: docker_user
      MYSQL_PASSWORD: docker_pass
    volumes:
      # Volume dibedakan agar data Dev tidak mencampuri data Prod
      - ${APP_NAME}_db_data:/var/lib/mysql
      - ./Tubes/database/pustani_db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      # Port database tidak perlu di-expose ke host (akses internal saja via network)
      # Kecuali butuh akses remote, hapus section ports ini agar aman
      - "3306" 
    networks:
      - pustani-net

  api-gateway:
    image: nginx:latest
    container_name: ${APP_NAME}-gateway
    ports:
      # Port luar dibuat dinamis (80 untuk Prod, 8080 untuk Dev)
      - "${HOST_PORT}:80"
    volumes:
      - ./infra/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - pustani-app
      - pustani-info
    networks:
      - pustani-net

# ... (Monitoring section bisa dihapus untuk Dev atau dibuat dinamis serupa) ...

networks:
  pustani-net:
    driver: bridge

volumes:
  # Volume dinamis berdasarkan nama project
  pustani_prod_db_data:
  pustani_dev_db_data: